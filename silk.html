<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vibes.ai - Redefining Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Lora:ital,wght@0,400;0,600;1,400&family=Space+Grotesk:wght@300;500;700&display=swap');

        :root {
            --bg-color: #fafafa;
            --text-main: #1e293b;
            --accent: #6366f1;
        }

        /* Hide Scrollbars Globally */
        * { scrollbar-width: none; -ms-overflow-style: none; }
        *::-webkit-scrollbar { display: none; }

        body {
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            background-color: var(--bg-color);
            transition: background-color 0.5s ease;
        }

        .immersive-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            /* Updated to use white, aliceblue, and honeydew palette */
            background-image: 
                radial-gradient(at 80% 0%, white 0px, transparent 50%),
                radial-gradient(at 0% 50%, aliceblue 0px, transparent 50%),
                radial-gradient(at 80% 50%, honeydew 0px, transparent 50%);
            z-index: -2;
            filter: blur(60px);
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        body.ui-immersive .immersive-bg { opacity: 1; }
        
        .siri-container {
            position: absolute;
            inset: -4px;
            pointer-events: none;
            z-index: -1;
        }

        .siri-ring {
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            padding: 2px;
            background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899, #6366f1);
            background-size: 200% 200%;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.4;
            filter: blur(4px);
            animation: moveGradient 4s linear infinite;
        }

        .siri-ring-2 {
            inset: -4px;
            background: linear-gradient(90deg, #8b5cf6, #d946ef, #6366f1, #8b5cf6);
            background-size: 200% 200%;
            opacity: 0.2;
            filter: blur(8px);
            animation: moveGradient 6s linear infinite reverse;
        }

        @keyframes moveGradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        body.ui-immersive .glass {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .smooth-transition { transition: all 0.5s cubic-bezier(0.2, 0, 0, 1); }
        
        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.2, 0, 0, 1) forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        #vibes-form {
            width: 100%;
            max-width: 420px;
            height: 48px;
            transition: all 0.5s cubic-bezier(0.2, 0, 0, 1);
        }

        body.ui-immersive #vibes-form {
            max-width: 600px;
            height: 60px;
            border-radius: 2rem;
        }

        .reasoning-box {
            font-size: 0.65rem;
            color: #94a3b8;
            font-family: 'JetBrains Mono', monospace;
            border-left: 1px solid #f1f5f9;
            padding-left: 10px;
            margin-bottom: 12px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.8;
        }

        .reasoning-step {
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            animation: fadeInStep 0.3s forwards;
        }

        @keyframes fadeInStep { to { opacity: 1; } }

        .formula-block {
            background: #1e293b;
            color: #f8fafc;
            padding: 1.5rem;
            border-radius: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            text-align: center;
            margin: 1rem 0;
        }

        /* Updated Zap Styling */
        .zap-active {
            color: #000000 !important;
            filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.1));
        }

        #deep-think-btn:hover .zap-icon {
            color: #000000 !important;
        }

        @keyframes pulse-energy {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.1); opacity: 1; }
        }

        .poem-container {
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            line-height: 1.8;
            font-style: italic;
            color: #475569;
            white-space: pre-wrap;
            border-left: 2px solid #e2e8f0;
            padding-left: 1.5rem;
            margin: 1.5rem 0;
        }

        .header-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .max-energy-glow {
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
        }

        .zap-status-pill {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 99px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
            width: fit-content;
        }
        
        .view-btn {
            color: #8b5cf6;
            font-weight: 600;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 8px;
        }

        #zap-viewer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 4rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #zap-viewer-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .prediction-card {
            border: 1px solid rgba(139, 92, 246, 0.1);
            background: rgba(139, 92, 246, 0.02);
            border-radius: 12px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        /* Replaced green with honeydew for medical highlights */
        .medical-highlight {
            border-left: 3px solid honeydew;
            padding-left: 1rem;
            margin: 1rem 0;
            background: rgba(240, 255, 240, 0.2); /* faint honeydew tint */
        }

        /* Chart Components */
        .chart-container {
            background: #fff;
            border: 1px solid #f1f5f9;
            border-radius: 1rem;
            padding: 1.25rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }
        .chart-bar {
            transition: height 1s ease-out;
            transform-origin: bottom;
        }
    </style>
</head>
<body class="text-slate-900 h-screen w-screen flex relative selection:bg-violet-100 overflow-hidden">

    <div class="immersive-bg"></div>

    <header class="absolute top-0 left-0 w-full p-8 flex justify-between items-start z-50">
        <div id="logo-trigger" class="cursor-default">
            <span class="text-sm font-bold tracking-widest text-slate-800 uppercase">vibes.ai</span>
        </div>
        <div class="flex items-center gap-4">
            <button id="ui-toggle-btn" class="header-badge hover:text-slate-900 transition-all">
                <i data-lucide="layers" class="w-3.5 h-3.5"></i>
                <span id="ui-label">Minimal UI</span>
            </button>
        </div>
    </header>

    <main id="main-container" class="flex-1 h-full flex flex-col items-center relative z-10 smooth-transition px-4 w-full">
        <div id="welcome-state-container" class="h-full flex flex-col justify-center items-center w-full smooth-transition">
            <div id="hero-text" class="text-center mb-8">
                <h1 id="main-title" class="text-3xl font-light text-slate-800 tracking-tight transition-all duration-700">
                    Catch the <span class="text-slate-400">vibe.</span>
                </h1>
            </div>
            <div id="initial-input-flow" class="w-full flex flex-col items-center smooth-transition">
                <div id="input-container" class="relative z-20 transition-all duration-500">
                    <div class="siri-container"><div class="siri-ring"></div><div class="siri-ring-2"></div></div>
                    <form id="vibes-form" class="relative glass rounded-full flex items-center px-2 shadow-sm">
                        <button type="button" id="deep-think-btn" class="p-2 text-slate-300 transition-colors">
                            <i data-lucide="zap" class="w-4 h-4 zap-icon transition-colors duration-200"></i>
                        </button>
                        <input type="text" id="user-input" placeholder="Neural interface active..." class="w-full bg-transparent border-none outline-none text-slate-800 placeholder-slate-300 px-3 font-light" autocomplete="off">
                        <button type="submit" id="submit-btn" class="p-2 text-slate-300 hover:text-slate-900 transition-colors">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
                <div id="quick-prompts" class="mt-8 flex gap-4 opacity-40 hover:opacity-100 transition-opacity"></div>
            </div>
        </div>

        <div id="chat-wrapper" class="w-full max-w-2xl flex-1 min-h-0 overflow-hidden flex flex-col hidden opacity-0 smooth-transition relative">
            <div id="chat-history" class="flex-1 overflow-y-auto pt-24 pb-32 space-y-8"></div>
        </div>
    </main>
    
    <div id="fixed-bottom-bar" class="fixed bottom-0 left-0 w-full flex flex-col items-center p-8 z-20 pointer-events-none hidden smooth-transition">
        <div id="fixed-input-target" class="w-full max-w-2xl pointer-events-auto flex flex-col items-center"></div>
    </div>

    <div id="zap-viewer-overlay">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-violet-600">Local Data Preview</h2>
            <button id="close-viewer" class="text-slate-400 hover:text-slate-900"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <pre id="zap-viewer-content" class="flex-1 overflow-auto bg-slate-50 p-8 rounded-2xl font-mono text-sm leading-relaxed whitespace-pre-wrap"></pre>
    </div>

    <script>
        lucide.createIcons();

        // Neural Data Engine: Restoration of All Domain Intelligence
        const DATA_ENGINE = {
            stocks: {
                "2025": "S&P 500: 6,420. Market driven by initial AGI infrastructure breakthroughs.",
                "2026": "S&P 500: 7,840. AI-infrastructure and renewable fusion sectors dominate.",
                "2027": "S&P 500: 8,910. Rise of automated supply chains and biotech longevity stocks.",
                "2028": "S&P 500: 10,200. First trillion-dollar individual wealth event recorded.",
                "2030": "S&P 500: 12,150. Decentralized autonomous corporations represent 30% of market cap.",
                "3000": "The Omega Market. Resources allocated by Dyson-intelligence."
            },
            medical: {
                "general": "Medical science is transitioning from reactive treatment to predictive bio-optimization. Silicon-based modeling now precedes all clinical trials.",
                "2026": "Nano-robotics enter Phase II trials for targeted oncology. Real-time blood glucose monitoring integrates with neural interfaces.",
                "2028": "The Longevity Breakthrough. Genomic refactoring becomes commercially available to reverse cellular aging markers.",
                "2030": "Synthetic organ printing achieves 99.9% biological parity. The concept of 'organ failure' becomes a legacy surgical problem.",
                "longevity": "Lifespan extension beyond 120 years becomes a statistical norm for those with access to the 2028 genomic refactor protocols.",
                "pathology": {
                    "cancer": "By 2029, oncology shifts from generalized chemotherapy to patient-specific mRNA-targeted antigens. Survival rates for Stage IV reach 84%.",
                    "alzheimers": "Neural plaque dissolution achieved through 2027 nanite-infusion techniques. Memory retrieval remains the secondary frontier.",
                    "diabetes": "Type 1 effectively resolved via 2026 automated islet-cell printing. Type 2 managed via metabolic refactoring."
                },
                "stats": {
                    "lifespan": [78, 82, 85, 94, 112, 145], // 2020, 2025, 2030, 2040, 2050, 2080
                    "organ_failure_rate": [100, 85, 40, 12, 2, 0]
                }
            },
            predictionTokens: {
                tech: ["Neural Link", "Fusion Power", "Quantum Mesh", "Bio-printed Organs", "Dyson Swarm", "Synthesized Logic"],
                state: ["Equilibrium", "Hyper-growth", "Stable", "Volatile", "Post-scarcity", "Expanding"],
                adjectives: ["Ubiquitous", "Invisible", "Harmonious", "Radical", "Seamless", "Evolved"]
            }
        };

        const form = document.getElementById('vibes-form');
        const input = document.getElementById('user-input');
        const welcomeStateContainer = document.getElementById('welcome-state-container'); 
        const chatWrapper = document.getElementById('chat-wrapper');
        const chatHistory = document.getElementById('chat-history');
        const inputContainer = document.getElementById('input-container'); 
        const fixedBottomBar = document.getElementById('fixed-bottom-bar'); 
        const fixedInputTarget = document.getElementById('fixed-input-target'); 
        const deepThinkBtn = document.getElementById('deep-think-btn');
        const uiToggleBtn = document.getElementById('ui-toggle-btn');
        const uiLabel = document.getElementById('ui-label');
        const mainTitle = document.getElementById('main-title');
        const quickPrompts = document.getElementById('quick-prompts');
        const viewerOverlay = document.getElementById('zap-viewer-overlay');
        const viewerContent = document.getElementById('zap-viewer-content');
        const closeViewer = document.getElementById('close-viewer');

        let isSessionActive = false;
        let isImmersiveMode = false;
        let isZapEnabled = false;
        let cycleIndex = 0;

        const promptRotator = [
            [ {l: "Stock 2040", q: "Market prediction for 2040"}, {l: "Math", q: "1250 * 4"}, {l: "Haiku", q: "Write a haiku about code"} ],
            [ {l: "Sonnet", q: "Write a sonnet about the future"}, {l: "Acrostic", q: "Acrostic poem for VIBES"}, {l: "Disease 2030", q: "Disease trends 2030"} ]
        ];

        function rotateSuggestions() {
            const currentSet = promptRotator[cycleIndex % promptRotator.length];
            quickPrompts.innerHTML = '';
            currentSet.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "prompt-btn text-[11px] uppercase tracking-widest text-slate-500 hover:text-slate-900";
                btn.innerText = item.l;
                btn.onclick = () => { input.value = item.q; form.dispatchEvent(new Event('submit')); };
                quickPrompts.appendChild(btn);
            });
            cycleIndex++;
        }
        rotateSuggestions();

        deepThinkBtn.addEventListener('click', () => {
            isZapEnabled = !isZapEnabled;
            const icon = deepThinkBtn.querySelector('.zap-icon');
            if (icon) icon.classList.toggle('zap-active', isZapEnabled);
            input.placeholder = isZapEnabled ? "Knowledge Engine: High-Frequency Agent..." : "Neural interface active...";
        });

        uiToggleBtn.addEventListener('click', () => {
            isImmersiveMode = !isImmersiveMode;
            document.body.classList.toggle('ui-immersive', isImmersiveMode);
            uiLabel.innerText = isImmersiveMode ? "Immersive UI" : "Minimal UI";
        });

        closeViewer.onclick = () => viewerOverlay.classList.remove('active');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const val = input.value.trim();
            if (!val) return;
            if (!isSessionActive) {
                isSessionActive = true;
                welcomeStateContainer.style.opacity = '0';
                setTimeout(() => {
                    welcomeStateContainer.style.display = 'none';
                    chatWrapper.classList.remove('hidden');
                    chatWrapper.classList.add('opacity-100');
                    fixedInputTarget.appendChild(inputContainer);
                    fixedBottomBar.classList.remove('hidden');
                }, 400);
            }
            addMessage('user', val);
            input.value = '';
            await processResponse(val);
        });

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in-up`;
            const inner = document.createElement('div');
            inner.className = role === 'user' 
                ? 'max-w-[85%] text-sm text-slate-600 bg-slate-100/50 px-4 py-2 rounded-2xl' 
                : 'max-w-[85%] text-sm text-slate-800 leading-relaxed w-full';
            inner.innerHTML = text;
            div.appendChild(inner);
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return inner;
        }

        function triggerDownload(text, filename) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function createChartSVG(data, labels, title, color = "honeydew") {
            const max = Math.max(...data);
            const height = 150;
            const width = 400;
            const barWidth = width / data.length - 10;
            
            let bars = data.map((d, i) => {
                const h = (d / max) * height;
                const x = i * (barWidth + 10);
                const y = height - h;
                return `
                    <g class="chart-group">
                        <rect class="chart-bar" x="${x}" y="${y}" width="${barWidth}" height="${h}" fill="${color}" stroke="#e2e8f0" stroke-width="1" rx="4" />
                        <text x="${x + barWidth/2}" y="${height + 15}" font-size="10" text-anchor="middle" fill="#94a3b8">${labels[i]}</text>
                        <text x="${x + barWidth/2}" y="${y - 5}" font-size="10" font-weight="bold" text-anchor="middle" fill="#475569">${d}</text>
                    </g>
                `;
            }).join('');

            return `
                <div class="chart-container fade-in-up">
                    <h4 class="text-[11px] uppercase tracking-wider font-bold text-slate-400 mb-4">${title}</h4>
                    <svg viewBox="0 0 ${width} ${height + 25}" width="100%" height="${height + 25}">
                        ${bars}
                    </svg>
                </div>
            `;
        }

        function generateVibePrediction(year, type = 'general') {
            const tokens = DATA_ENGINE.predictionTokens;
            const seed = parseInt(year);
            const tech = tokens.tech[seed % tokens.tech.length];
            const state = tokens.state[seed % tokens.state.length];
            const adj = tokens.adjectives[seed % tokens.adjectives.length];

            if (type === 'stock') {
                const baseVal = 7000;
                const multiplier = 1 + ((seed - 2025) * 0.15);
                const projectedVal = Math.floor(baseVal * multiplier);
                return `S&P 500 Projection for ${year}: ~${projectedVal.toLocaleString()}. The market enters a ${adj} ${state} phase, primarily driven by ${tech} integration.`;
            }

            return `By ${year}, the global vibe is characterized as ${adj}. We observe a ${state} transition where ${tech} becomes the dominant socioeconomic driver. Infrastructure shifts toward autonomous mesh networks.`;
        }

        async function processResponse(query) {
            const container = addMessage('ai', '');
            const reasoningBox = document.createElement('div');
            reasoningBox.className = 'reasoning-box';
            container.appendChild(reasoningBox);

            const addStep = async (txt) => {
                const step = document.createElement('div');
                step.className = 'reasoning-step';
                step.innerHTML = `<span class="text-slate-300 mr-2">></span><span>${txt}</span>`;
                reasoningBox.appendChild(step);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                await new Promise(r => setTimeout(r, 400));
            };

            await addStep("Polling vibe vectors...");
            await addStep(isZapEnabled ? "Deep Vibe Triggered: Archiving local state..." : "Synthesizing intent...");

            let responseHTML = '';
            let rawText = '';
            const q = query.toLowerCase();
            const yearMatch = q.match(/\b(202[6-9]|20[3-9]\d|2\d{3}|3000)\b/);

            // Chart Logic
            if (q.includes('chart') || q.includes('trend') || q.includes('stat')) {
                if (q.includes('lifespan')) {
                    const data = DATA_ENGINE.medical.stats.lifespan;
                    const labels = ['2020', '2025', '2030', '2040', '2050', '2080'];
                    responseHTML = createChartSVG(data, labels, "Projected Lifespan (Avg Years)");
                    rawText = "Visualizing projected lifespan trends based on 2028 longevity breakthroughs.";
                } else if (q.includes('organ') || q.includes('failure')) {
                    const data = DATA_ENGINE.medical.stats.organ_failure_rate;
                    const labels = ['2020', '2025', '2030', '2040', '2050', '2080'];
                    responseHTML = createChartSVG(data, labels, "Organ Failure Index (%)");
                    rawText = "Projection: Decline of fatal organ failure due to synthetic bioprinting.";
                }
            }

            // Disease Logic
            if (!responseHTML) {
                let foundDisease = false;
                for (const [key, value] of Object.entries(DATA_ENGINE.medical.pathology)) {
                    if (q.includes(key)) {
                        rawText = value;
                        responseHTML = `
                            <div class="medical-highlight">
                                <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 block mb-1">Vibe Pathology: ${key}</span>
                                <p class="text-sm">${value}</p>
                            </div>
                        `;
                        foundDisease = true;
                        break;
                    }
                }
            }

            // Predictive Logic for Years 2026-3000
            if (!responseHTML && yearMatch) {
                const year = yearMatch[0];
                const yearInt = parseInt(year);
                
                if (yearInt >= 2026 && yearInt <= 3000) {
                    await addStep(`Year ${year} detected. Checking known vectors...`);
                    
                    if (q.includes('stock') || q.includes('market') || q.includes('economy')) {
                        rawText = DATA_ENGINE.stocks[year] || generateVibePrediction(year, 'stock');
                    } else if (q.includes('medical') || q.includes('health')) {
                        rawText = DATA_ENGINE.medical[year] || generateVibePrediction(year, 'medical');
                    } else {
                        rawText = generateVibePrediction(year, 'general');
                    }

                    const isPrediction = !DATA_ENGINE.stocks[year] && !DATA_ENGINE.medical[year];
                    if (isPrediction) await addStep("No direct match. Initiating predictive vibe extrapolation...");

                    responseHTML = `
                        <div class="prediction-card">
                            <span class="text-[10px] font-bold uppercase tracking-widest text-violet-500 block mb-1">
                                ${isPrediction ? 'Vibe Extrapolation' : 'Historical Forecast'}: ${year}
                            </span>
                            <p class="text-sm leading-relaxed">${rawText}</p>
                        </div>
                    `;
                }
            }

            // Poetics Module (Vibes Edition)
            if (!responseHTML) {
                if (q.includes('haiku')) {
                    rawText = "Silent gray light,\nLogic flows through empty space,\nMind and vibe are one.";
                    responseHTML = `<div class="poem-container">${rawText}</div>`;
                } else if (q.includes('acrostic')) {
                    rawText = "V - Vast\nI - Intelligent\nB - Bio-digital\nE - Eternal\nS - Synthesis";
                    responseHTML = `<div class="poem-container font-mono">${rawText}</div>`;
                } else if (q.includes('poem')) {
                    rawText = "The silicon pulse, a rhythm of light,\nTracing the pathways of electric sight.\nBeyond the horizon where data flows free,\nWe find the vibes in the neural tree.";
                    responseHTML = `<div class="poem-container">${rawText}</div>`;
                }
            }

            // Math Logic
            if (!responseHTML && q.match(/[0-9]/) && (q.match(/[\+\*\/\\-]/))) {
                try {
                    const cleanQ = q.replace(/[^-()\d/*+.]/g, '');
                    const result = eval(cleanQ);
                    rawText = `Computation result: ${result}`;
                    responseHTML = `<div class="formula-block">${result}</div>`;
                } catch { responseHTML = "<p>Mathematical parse error.</p>"; }
            }

            // Final Fallback
            if (!responseHTML) {
                rawText = `Vibe check complete for "${query}". Our synthesis indicates a transition toward decentralized intelligence.`;
                responseHTML = `<p>${rawText}</p>`;
            }

            const textDiv = document.createElement('div');
            textDiv.innerHTML = responseHTML;
            container.appendChild(textDiv);

            if (isZapEnabled) {
                triggerDownload(rawText, `vibes-archival-${Date.now()}.txt`);
                const statusPill = document.createElement('div');
                statusPill.className = 'zap-status-pill fade-in-up text-slate-500';
                statusPill.innerHTML = `
                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                    <span>Vibe Archived</span>
                    <span class="view-btn" id="open-view">View Raw</span>
                `;
                container.appendChild(statusPill);
                lucide.createIcons();
                statusPill.querySelector('#open-view').onclick = () => {
                    viewerContent.innerText = rawText;
                    viewerOverlay.classList.add('active');
                };
            }
            rotateSuggestions();
        }
    </script>
</body>
</html>
